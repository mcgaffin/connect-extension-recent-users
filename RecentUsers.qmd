---
title: "Last 10 Active Users"
---

```{python}
#| echo: false

import json
import os
from posit.connect import Client

CONNECT_API_KEY = os.getenv('CONNECT_API_KEY')
CONNECT_SERVER = os.getenv('CONNECT_SERVER')

def sort_by_login(user):
  return user['active_time']

def find_users():
  with Client(
  api_key=CONNECT_API_KEY, url=CONNECT_SERVER
  ) as client:
    find_results = client.users.find()
    find_results.sort(key=sort_by_login, reverse=True)
    return find_results

```

```{python}
#| echo: false

from IPython.display import Markdown
from tabulate import tabulate
from datetime import *
import pytz

def last_active_time(dt):
  utc_time = pytz.utc.localize(dt)
  local_timezone = pytz.timezone('US/Eastern')
  local_time = utc_time.astimezone(local_timezone)
  # return local_time.strftime("%Y-%m-%d %-I:%M %p")
  return local_time.strftime("%c")

output = None
if CONNECT_API_KEY and CONNECT_SERVER:
  recent_users = find_users()
  display_users = []
  for user in recent_users[:10]:
    local_time = datetime.strptime(user.active_time, '%Y-%m-%dT%H:%M:%SZ')

    display_users.append({
      'email': user.email,
      'name': f'{user.first_name} {user.last_name}',
      'username': user.username,
      'last_active': last_active_time(local_time)
    })

  rows = [x.values() for x in display_users]

  output = tabulate( rows, headers=["Email", "Name", "Username", "Last Active"])
else:
  output = '''
  **Incomplete Setup**

  Please visit the **Vars** settings pane for this content and set the following variables:\n
  * `CONNECT_API_KEY` (e.g., `'zftgnq7HAK3kCmPLK65UJDDtYdqhbCVS'`)
  * `CONNECT_SERVER` (e.g., `'https://posit-connect.example.com:3939'`)

  Once those variables are set you can re-render this content to view the report.
  '''

Markdown(output)
```